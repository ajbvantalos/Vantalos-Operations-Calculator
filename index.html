<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unit Economics Planner — Clean Layout</title>
  <style>
    :root{
      --bg:#0b0c10; --surface:#131827; --surface-2:#1a2133; --surface-3:#212a41;
      --text:#eef0f4; --muted:#9ea6ba; --accent:#d3b99c; --border:#2a3350;
      --ok:#2ecc71; --warn:#f39c12; --bad:#e74c3c; --radius:14px; --shadow:0 8px 28px rgba(0,0,0,.4);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    h1{font-size:1.6rem;margin:0}
    h2{font-size:1rem;color:var(--muted);margin:.2rem 0 .6rem}
    h3{font-size:.95rem;color:var(--accent);margin:0 0 .4rem}
    p{margin:.2rem 0;color:var(--muted)}

    .app{max-width:1200px;margin:0 auto;padding:18px}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{display:flex;gap:10px;align-items:center}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 6px #d3b99c22}

    /* Layout: left inputs / right results */
    .layout{display:grid;grid-template-columns:340px 1fr;gap:14px}
    @media (max-width:980px){.layout{grid-template-columns:1fr}}

    .panel{background:linear-gradient(180deg,var(--surface),var(--surface-2));border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .panel .inner{padding:14px}

    /* Inputs sidebar */
    .group{border-top:1px solid var(--border)}
    .group:first-child{border-top:0}
    .group header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;cursor:pointer}
    .group header:hover{background:var(--surface-3)}
    .group header h3{margin:0}
    .group .body{padding:0 14px 14px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:520px){.grid-2{grid-template-columns:1fr}}

    label{font-size:.82rem;color:var(--muted)}
    input,select{width:100%;border:1px solid var(--border);background:#161d2d;color:var(--text);padding:10px;border-radius:10px;font-size:.95rem;outline:none;transition:.2s}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px #d3b99c33}

    /* Results */
    .results{display:grid;grid-template-rows:auto auto 1fr;gap:14px}

    .toolbar{display:flex;gap:8px;align-items:center}
    button{border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn{background:var(--accent);color:#16181f}
    .btn.ghost{background:transparent;color:var(--text);border:1px solid var(--border);font-weight:600}

    .kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:800px){.kpi-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.kpi-grid{grid-template-columns:1fr}}
    .kpi{background:var(--surface-3);border:1px solid var(--border);border-radius:12px;padding:10px}
    .kpi .value{font-weight:800;font-size:1.3rem}
    .kpi .label{font-size:.85rem;color:var(--muted)}

    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (max-width:800px){.two-col{grid-template-columns:1fr}}

    .list{display:flex;flex-direction:column;gap:8px}
    .item{display:flex;justify-content:space-between;align-items:center;background:#1a2133;border:1px solid var(--border);border-radius:12px;padding:8px 10px}
    .item input{min-width:0}

    .tabbar{display:flex;gap:8px}
    .tab{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:#1a2133;cursor:pointer}
    .tab.active{background:#232b44}

    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand"><div class="dot"></div><div><h1>Unit Economics Planner</h1><h2>Order: Inputs → Summary KPIs → Details. Accuracy first.</h2></div></div>
      <div class="toolbar">
        <select id="currency"><option value="USD">$ USD</option><option value="GBP">£ GBP</option></select>
        <input id="fx" type="number" step="0.0001" value="0.78" title="FX (1 USD → GBP)"/>
        <button class="btn" id="recalc">Recalculate</button>
        <button class="btn ghost" id="export">Export JSON</button>
        <button class="btn ghost" id="import">Import JSON</button>
        <button class="btn ghost" id="resetAll">Reset</button>
      </div>
    </div>

    <div class="layout">
      <!-- LEFT: Inputs Sidebar (accordion groups) -->
      <aside class="panel" aria-label="Inputs">
        <div class="group" data-open="true">
          <header><h3>Avenor Revenue</h3><span>per active carrier</span></header>
          <div class="body">
            <div class="grid-2">
              <div><label for="revPerCarrier">Typical ($/carrier)</label><input id="revPerCarrier" type="number" value="800"></div>
              <div><label for="revPerCarrierGood">Good month ($/carrier)</label><input id="revPerCarrierGood" type="number" value="1000"></div>
              <div><label for="avenorPct">Avenor dispatch %</label><input id="avenorPct" type="number" step="0.1" value="5"></div>
              <div><label for="avenorPctWhatIf">What‑if dispatch %</label><input id="avenorPctWhatIf" type="number" step="0.1" value="5"></div>
              <div style="grid-column:1/3"><label for="useGood">Use good‑month revenue?</label><select id="useGood"><option value="no">No</option><option value="yes">Yes</option></select></div>
            </div>
          </div>
        </div>

        <div class="group">
          <header><h3>Commission</h3><span>thresholded</span></header>
          <div class="body">
            <div class="grid-2">
              <div><label for="threshold">Threshold ($)</label><input id="threshold" type="number" value="3100"></div>
              <div><label for="rate">Rate above threshold (%)</label><input id="rate" type="number" step="0.1" value="15"></div>
              <div style="grid-column:1/3"><label for="targetCommission">Target commission ($)</label><input id="targetCommission" type="number" value="2700"></div>
            </div>
          </div>
        </div>

        <div class="group">
          <header><h3>Funnel</h3><span>pre‑data</span></header>
          <div class="body">
            <div class="grid-2">
              <div><label for="pCE">Contact → Engaged (%)</label><input id="pCE" type="number" step="0.1" value="20"></div>
              <div><label for="pEO">Engaged → Onboarded (%)</label><input id="pEO" type="number" step="0.1" value="50"></div>
              <div><label for="pOA">Onboarded → Active (%)</label><input id="pOA" type="number" step="0.1" value="70"></div>
              <div><label for="buffer">Buffer (%)</label><input id="buffer" type="number" step="0.1" value="20"></div>
            </div>
          </div>
        </div>

        <div class="group">
          <header><h3>Costs</h3><span>editable</span></header>
          <div class="body">
            <h3>Fixed</h3>
            <div id="fixedList" class="list" aria-live="polite"></div>
            <div style="display:flex;gap:8px;margin:8px 0 12px"><button class="btn" id="addFixed">+ Add item</button><button class="btn ghost" id="resetFixed">Reset → $50 default</button></div>
            <div class="grid-2">
              <div class="item"><span>Monthlyized total</span><span class="mono" id="fixedMonthly"></span></div>
              <div class="item"><span>Cash outflow this month</span><span class="mono" id="fixedThisMonth"></span></div>
            </div>
            <div style="height:10px"></div>
            <h3>Variable</h3>
            <div class="tabbar" style="margin:6px 0 8px">
              <div class="tab active" data-tab="calls">AI Calls</div>
              <div class="tab" data-tab="email">Email</div>
            </div>
            <div id="tabCalls">
              <div class="grid-2">
                <div><label for="costCallAttempt">Cost per call attempt ($)</label><input id="costCallAttempt" type="number" step="0.0001" value="0.40"></div>
                <div><label for="attemptsPerReach">Attempts per human reach</label><input id="attemptsPerReach" type="number" step="0.1" value="1.5"></div>
                <div><label>Cost per reached human (auto)</label><input id="costPerReach" type="number" disabled></div>
                <div><label>Cost for required contacts (auto)</label><input id="costCallsTotal" type="text" disabled></div>
              </div>
            </div>
            <div id="tabEmail" style="display:none">
              <div class="grid-2">
                <div><label for="costEmailSend">Cost per email send ($)</label><input id="costEmailSend" type="number" step="0.0001" value="0.003"></div>
                <div><label for="sendsPerProspect">Sends per prospect</label><input id="sendsPerProspect" type="number" step="1" value="2"></div>
                <div><label>Cost per contacted prospect (auto)</label><input id="costEmailPerContact" type="number" disabled></div>
                <div><label>Cost for required contacts (auto)</label><input id="costEmailTotal" type="text" disabled></div>
              </div>
            </div>
          </div>
        </div>
      </aside>

      <!-- RIGHT: Results -->
      <main class="results">
        <!-- KPI header -->
        <section class="panel"><div class="inner">
          <h3>Summary KPIs</h3>
          <div class="kpi-grid">
            <div class="kpi"><div class="value mono" id="revPerCarrierDisplay"></div><div class="label">Revenue / carrier</div></div>
            <div class="kpi"><div class="value mono" id="totalAvenorRevenue"></div><div class="label">Total Avenor revenue</div></div>
            <div class="kpi"><div class="value mono" id="commissionOut"></div><div class="label">Our commission</div></div>
            <div class="kpi"><div class="value mono" id="breakevenRevenue"></div><div class="label">Breakeven total revenue</div></div>
          </div>
        </div></section>

        <!-- Compact strips (consistent placement) -->
        <section class="two-col">
          <div class="panel"><div class="inner">
            <h3>Commission Snapshot</h3>
            <div class="kpi-grid">
              <div class="kpi"><div class="value mono" id="aboveThreshold"></div><div class="label">Region</div></div>
              <div class="kpi"><div class="value mono" id="effectiveRate"></div><div class="label">Effective rate vs total</div></div>
              <div class="kpi"><div class="value mono" id="aboveThreshAmount"></div><div class="label">Above threshold</div></div>
              <div class="kpi"><div class="value mono" id="whatIfRev"></div><div class="label">What‑if / carrier</div></div>
            </div>
          </div></div>
          <div class="panel"><div class="inner">
            <h3>Carriers & Contacts</h3>
            <div class="kpi-grid">
              <div class="kpi"><div class="value mono" id="carriersExact"></div><div class="label">Carriers (exact)</div></div>
              <div class="kpi"><div class="value mono" id="carriersFC"></div><div class="label">Floor / Ceil</div></div>
              <div class="kpi"><div class="value mono" id="carriersRec"></div><div class="label">Recommended</div></div>
              <div class="kpi"><div class="value mono" id="contactsNeeded"></div><div class="label">Contacts needed</div></div>
            </div>
          </div></div>
        </section>

        <!-- Breakeven always last -->
        <section class="two-col">
          <div class="panel"><div class="inner">
            <h3>Breakeven — Contacts</h3>
            <div class="list">
              <div class="item"><span>AI Calls</span><span class="mono" id="beContactsCalls"></span></div>
              <div class="item"><span>Email</span><span class="mono" id="beContactsEmail"></span></div>
            </div>
          </div></div>
          <div class="panel"><div class="inner">
            <h3>Breakeven — Commission & Revenue</h3>
            <div class="list">
              <div class="item"><span>Breakeven commission</span><span class="mono" id="beCommission"></span></div>
              <div class="item"><span>Implied revenue above threshold</span><span class="mono" id="beRevAbove"></span></div>
              <div class="item"><span>Total implied Avenor revenue</span><span class="mono" id="beTotalRev"></span></div>
            </div>
          </div></div>
        </section>

        <!-- Footer summary line -->
        <section class="panel"><div class="inner">
          <div class="item"><span>Summary</span><span class="mono" id="headline"></span></div>
        </div></section>
      </main>
    </div>
  </div>

  <script>
  (function(){
    const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
    const fmt=n=>{ const c=$('#currency').value; const fx=parseFloat($('#fx').value)||1; let usd=Number(n||0); return c==='GBP' ? '£'+(usd*fx).toLocaleString(undefined,{maximumFractionDigits:2}) : '$'+usd.toLocaleString(undefined,{maximumFractionDigits:2}); };

    // Accordion behaviour
    $$('.group header').forEach(h=>{ h.addEventListener('click',()=>{ const g=h.parentElement; const open=g.getAttribute('data-open')==='true'; g.setAttribute('data-open', String(!open)); g.querySelector('.body').style.display = open ? 'none' : 'block'; }); const g=h.parentElement; if(g.getAttribute('data-open')==='true'){ g.querySelector('.body').style.display='block'; } else { g.querySelector('.body').style.display='none'; } });

    const els={
      revPerCarrier:$('#revPerCarrier'), revPerCarrierGood:$('#revPerCarrierGood'), avenorPct:$('#avenorPct'), avenorPctWhatIf:$('#avenorPctWhatIf'), useGood:$('#useGood'),
      threshold:$('#threshold'), rate:$('#rate'), targetCommission:$('#targetCommission'),
      pCE:$('#pCE'), pEO:$('#pEO'), pOA:$('#pOA'), buffer:$('#buffer'), currency:$('#currency'), fx:$('#fx'),
      derivedGross:$('#derivedGross'), whatIfRev:$('#whatIfRev'), revPerCarrierDisplay:$('#revPerCarrierDisplay'), totalRevNeeded:$('#totalAvenorRevenue'),
      commissionOut:$('#commissionOut'), aboveThreshold:$('#aboveThreshold'), effectiveRate:$('#effectiveRate'), breakevenRevenue:$('#breakevenRevenue'),
      carriersExact:$('#carriersExact'), carriersFC:$('#carriersFC'), carriersRec:$('#carriersRec'), totalAvenorRevenue:$('#totalAvenorRevenue'), aboveThreshAmount:$('#aboveThreshAmount'), commissionCheck:$('#commissionCheck'),
      funnelMultiplier:$('#funnelMultiplier'), contactsNeeded:$('#contactsNeeded'), headline:$('#headline'),
      // Fixed
      fixedList:$('#fixedList'), fixedMonthly:$('#fixedMonthly'), fixedThisMonth:$('#fixedThisMonth'), addFixed:$('#addFixed'), resetFixed:$('#resetFixed'),
      // Vars
      costCallAttempt:$('#costCallAttempt'), attemptsPerReach:$('#attemptsPerReach'), costPerReach:$('#costPerReach'), costCallsTotal:$('#costCallsTotal'),
      costEmailSend:$('#costEmailSend'), sendsPerProspect:$('#sendsPerProspect'), costEmailPerContact:$('#costEmailPerContact'), costEmailTotal:$('#costEmailTotal'),
      // Tabs
      tabCalls:$('#tabCalls'), tabEmail:$('#tabEmail'),
      // Breakeven
      beContactsCalls:$('#beContactsCalls'), beContactsEmail:$('#beContactsEmail'), beCommission:$('#beCommission'), beRevAbove:$('#beRevAbove'), beTotalRev:$('#beTotalRev')
    };

    // Fixed list model
    let fixed=[{name:'Operations baseline', cadence:'monthly', amountUSD:50, paidThisMonth:true}];
    function renderFixed(){
      els.fixedList.innerHTML=''; let monthly=0, cash=0;
      fixed.forEach((f,i)=>{
        const mult=f.cadence==='annual'?1/12:1; monthly+=f.amountUSD*mult; cash+=f.paidThisMonth?f.amountUSD:0;
        const row=document.createElement('div'); row.className='item';
        row.innerHTML=`
          <input style="flex:2" value="${f.name}">
          <select style="flex:1"><option ${f.cadence==='monthly'?'selected':''} value="monthly">monthly</option><option ${f.cadence==='annual'?'selected':''} value="annual">annual</option></select>
          <input style="flex:1" type="number" step="0.01" value="${f.amountUSD}">
          <label style="display:flex;gap:6px;align-items:center"><input type="checkbox" ${f.paidThisMonth?'checked':''}><span class="mono">cash</span></label>
          <button class="btn ghost" data-del="${i}">✕</button>`;
        const [nameEl,cadEl,amtEl,chkEl,delBtn]=row.querySelectorAll('input,select,button');
        nameEl.addEventListener('input',()=>{f.name=nameEl.value; calc();});
        cadEl.addEventListener('change',()=>{f.cadence=cadEl.value; calc();});
        amtEl.addEventListener('input',()=>{f.amountUSD=parseFloat(amtEl.value)||0; calc();});
        chkEl.addEventListener('change',()=>{f.paidThisMonth=chkEl.checked; calc();});
        delBtn.addEventListener('click',()=>{fixed.splice(i,1); renderFixed(); calc();});
        els.fixedList.appendChild(row);
      });
      els.fixedMonthly.textContent=fmt(monthly); els.fixedThisMonth.textContent=fmt(cash);
      return {monthlyTotal:monthly, cashThisMonth:cash};
    }

    // Tabs
    document.querySelectorAll('.tab').forEach(t=>t.addEventListener('click',()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      els.tabCalls.style.display = t.dataset.tab==='calls'? 'block':'none';
      els.tabEmail.style.display = t.dataset.tab==='email'? 'block':'none';
    }));

    // Add/reset fixed
    els.addFixed.addEventListener('click',()=>{fixed.push({name:'New item', cadence:'monthly', amountUSD:0, paidThisMonth:false}); renderFixed(); calc();});
    els.resetFixed.addEventListener('click',()=>{fixed=[{name:'Operations baseline', cadence:'monthly', amountUSD:50, paidThisMonth:true}]; renderFixed(); calc();});

    function compute(){
      const revTypical=parseFloat(els.revPerCarrier.value)||0;
      const revGood=parseFloat(els.revPerCarrierGood.value)||0;
      const avenorPct=(parseFloat(els.avenorPct.value)||0)/100;
      const avenorPctWhatIf=(parseFloat(els.avenorPctWhatIf.value)||0)/100;
      const useGood=els.useGood.value==='yes';
      const revPerCarrier=useGood?revGood:revTypical;

      const threshold=parseFloat(els.threshold.value)||0;
      const rate=(parseFloat(els.rate.value)||0)/100;
      const targetCommission=parseFloat(els.targetCommission.value)||0;

      const pCE=(parseFloat(els.pCE.value)||0)/100;
      const pEO=(parseFloat(els.pEO.value)||0)/100;
      const pOA=(parseFloat(els.pOA.value)||0)/100;
      const buffer=(parseFloat(els.buffer.value)||0)/100;

      const grossPerCarrier=avenorPct>0 ? (revTypical/avenorPct) : 0;
      const whatIfRev=grossPerCarrier*avenorPctWhatIf;

      let carriersExact=0; if(revPerCarrier>0 && rate>0){ const neededAbove=targetCommission/rate + threshold; carriersExact = neededAbove/revPerCarrier; }
      const carriersFloor=Math.floor(carriersExact); const carriersCeil=Math.ceil(carriersExact); const carriersRec=Math.max(0,carriersCeil);

      const totalAvenorRevenue=revPerCarrier*carriersRec; const aboveAmt=Math.max(0,totalAvenorRevenue-threshold); const commissionCheck=aboveAmt*rate;

      const conv=pCE*pEO*pOA; const contactsPerActive = conv>0 ? (1/conv)*(1+buffer) : 0; const contactsNeeded=Math.ceil(contactsPerActive*carriersRec);

      const {monthlyTotal:fixedMonthly}=renderFixed();

      const costCallAttempt=parseFloat(els.costCallAttempt.value)||0; const attemptsPerReach=parseFloat(els.attemptsPerReach.value)||1; const costPerReach=costCallAttempt*attemptsPerReach; const costCallsTotal=contactsNeeded*costCallAttempt;
      const costEmailSend=parseFloat(els.costEmailSend.value)||0; const sendsPerProspect=parseInt(els.sendsPerProspect.value)||1; const costEmailPerContact=costEmailSend*sendsPerProspect; const costEmailTotal=contactsNeeded*costEmailPerContact;

      function commissionFromContacts(N){ const carriers=contactsPerActive>0 ? (N/contactsPerActive) : 0; const totalRev=revPerCarrier*carriers; const above=Math.max(0,totalRev-threshold); return above*rate; }
      function solveBreakevenContacts(varCost){ let lo=0,hi=1e6; for(let i=0;i<40;i++){ const mid=(lo+hi)/2; const lhs=commissionFromContacts(mid); const rhs=fixedMonthly+varCost*mid; if(lhs>=rhs) hi=mid; else lo=mid; } return Math.round(hi); }
      const beContactsCalls=solveBreakevenContacts(costCallAttempt); const beContactsEmail=solveBreakevenContacts(costEmailPerContact);

      const totalCostCalls=fixedMonthly+costCallsTotal; const totalCostEmail=fixedMonthly+costEmailTotal; const beCommissionUSD=Math.min(totalCostCalls,totalCostEmail); const beRevAbove=rate>0 ? (beCommissionUSD/rate) : 0; const beTotalRev=beRevAbove+threshold;

      // Update UI
      els.revPerCarrierDisplay.textContent=fmt(revPerCarrier);
      els.totalAvenorRevenue.textContent=fmt(totalAvenorRevenue);
      els.commissionOut.textContent=fmt(commissionCheck);
      els.breakevenRevenue.textContent=fmt(beTotalRev);

      els.aboveThreshold.textContent=aboveAmt>0? 'Above':'Below';
      const effRate= totalAvenorRevenue>0 ? (commissionCheck/totalAvenorRevenue)*100 : 0; els.effectiveRate.textContent=effRate.toFixed(2)+'%';
      els.aboveThreshAmount.textContent=fmt(aboveAmt);
      els.whatIfRev.textContent=fmt(whatIfRev);

      els.carriersExact.textContent=carriersExact.toFixed(2); els.carriersFC.textContent=`${carriersFloor} / ${carriersCeil}`; els.carriersRec.textContent=String(carriersRec); els.contactsNeeded.textContent=String(contactsNeeded);

      els.costPerReach.value=costPerReach.toFixed(4); els.costCallsTotal.value=fmt(costCallsTotal); els.costEmailPerContact.value=costEmailPerContact.toFixed(4); els.costEmailTotal.value=fmt(costEmailTotal);

      els.beContactsCalls.textContent=String(beContactsCalls); els.beContactsEmail.textContent=String(beContactsEmail); els.beCommission.textContent=fmt(beCommissionUSD); els.beRevAbove.textContent=fmt(beRevAbove); els.beTotalRev.textContent=fmt(beTotalRev);

      els.headline.textContent=`${carriersRec} carriers → ${contactsNeeded} contacts | Commission ${fmt(commissionCheck)} | Costs (calls) ${fmt(totalCostCalls)} / (email) ${fmt(totalCostEmail)}`;
    }

    function calc(){ compute(); }

    // Wire inputs
    $$('input,select').forEach(el=>{ el.addEventListener('input',calc); el.addEventListener('change',calc); });
    $('#recalc').addEventListener('click',calc); $('#currency').addEventListener('change',calc);

    // Export/Import/Reset
    function snapshot(){ return { revPerCarrier:+els.revPerCarrier.value, revPerCarrierGood:+els.revPerCarrierGood.value, avenorPct:+els.avenorPct.value, avenorPctWhatIf:+els.avenorPctWhatIf.value, useGood:els.useGood.value, threshold:+els.threshold.value, rate:+els.rate.value, targetCommission:+els.targetCommission.value, pCE:+els.pCE.value, pEO:+els.pEO.value, pOA:+els.pOA.value, buffer:+els.buffer.value, fixed, costCallAttempt:+els.costCallAttempt.value, attemptsPerReach:+els.attemptsPerReach.value, costEmailSend:+els.costEmailSend.value, sendsPerProspect:+els.sendsPerProspect.value, currency:$('#currency').value, fx:+$('#fx').value }; }
    function load(state){ if(!state) return; els.revPerCarrier.value=state.revPerCarrier??800; els.revPerCarrierGood.value=state.revPerCarrierGood??1000; els.avenorPct.value=state.avenorPct??5; els.avenorPctWhatIf.value=state.avenorPctWhatIf??5; els.useGood.value=state.useGood??'no'; els.threshold.value=state.threshold??3100; els.rate.value=state.rate??15; els.targetCommission.value=state.targetCommission??2700; els.pCE.value=state.pCE??20; els.pEO.value=state.pEO??50; els.pOA.value=state.pOA??70; els.buffer.value=state.buffer??20; fixed = Array.isArray(state.fixed)&&state.fixed.length? state.fixed : fixed; els.costCallAttempt.value=state.costCallAttempt??0.4; els.attemptsPerReach.value=state.attemptsPerReach??1.5; els.costEmailSend.value=state.costEmailSend??0.003; els.sendsPerProspect.value=state.sendsPerProspect??2; $('#currency').value=state.currency??'USD'; $('#fx').value=state.fx??0.78; renderFixed(); calc(); }

    document.getElementById('export').addEventListener('click',()=>{ const data=JSON.stringify(snapshot(),null,2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='planner_state.json'; a.click(); URL.revokeObjectURL(url); });
    document.getElementById('import').addEventListener('click',()=>{ const inp=document.createElement('input'); inp.type='file'; inp.accept='.json,application/json'; inp.onchange=()=>{ const f=inp.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ load(JSON.parse(fr.result)); }catch(e){ alert('Invalid JSON'); } }; fr.readAsText(f); }; inp.click(); });
    document.getElementById('resetAll').addEventListener('click',()=>{ localStorage.removeItem('planner_state_clean'); location.reload(); });

    function persist(){ localStorage.setItem('planner_state_clean', JSON.stringify(snapshot())); }
    window.addEventListener('beforeunload', persist);

    renderFixed(); const saved=localStorage.getItem('planner_state_clean'); if(saved){ try{ load(JSON.parse(saved)); }catch(e){ calc(); } } else { calc(); }
  })();
  </script>
</body>
</html>

